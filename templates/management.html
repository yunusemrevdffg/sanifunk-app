{% extends "base.html" %}
{% block content %}
<style>
    :root { --red: #ff0000; --dark: #000; --blue: #007bff; --green: #28a745; --orange: #ff9800; }
    body { background: #f4f4f4; padding-bottom: 110px; font-family: 'Arial Black', sans-serif; }
    
    .admin-header { background: var(--dark); color: white; padding: 25px; text-align: center; border-bottom: 5px solid var(--red); }
    .section-title { padding: 12px 15px; border-left: 8px solid var(--red); margin: 20px 10px 10px 10px; background: white; text-transform: uppercase; font-size: 1.1em; }
    
    .card { background: white; border: 2px solid var(--dark); margin: 15px 10px; padding: 15px; box-shadow: 5px 5px 0px var(--dark); position: relative; }
    .report-card { border-color: var(--orange); box-shadow: 5px 5px 0px var(--orange); background: #fffdf9; }
    .owner-card { border: 3px solid var(--blue); box-shadow: 5px 5px 0px var(--blue); }
    .card.banned { background: #e0e0e0; opacity: 0.9; }
    
    .info-box { background: #eee; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 0.85em; border: 1px solid #ccc; max-height: 150px; overflow-y: auto; }
    .pw-input { width: 100%; padding: 8px; margin-top: 5px; border: 2px solid #000; font-family: monospace; box-sizing: border-box; }
    
    .actions { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; }
    .actions select, .actions .btn-action { padding: 10px; font-weight: bold; border: 2px solid var(--dark); cursor: pointer; font-size: 0.75em; text-transform: uppercase; text-decoration: none; color: black; background: white; }
    
    .btn-save { background: var(--green) !important; color: white !important; width: 100%; margin-top: 5px; }
    .btn-ban { background: var(--dark) !important; color: white !important; }
    .btn-unban { background: var(--orange) !important; color: white !important; }
    .btn-chat { background: var(--blue) !important; color: white !important; flex: 1; text-align: center; }
    .btn-del { background: var(--red) !important; color: white !important; width: 100%; }
    .btn-user-del { background: #000 !important; color: var(--red) !important; border: 2px solid var(--red) !important; width: 100%; margin-top: 10px; }

    .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 5px solid var(--red); z-index: 1000; }
    .nav-item { flex: 1; text-align: center; text-decoration: none; color: black; font-size: 0.7em; font-weight: bold; text-transform: uppercase; }
    .nav-item.active { color: var(--red); }
</style>

<div class="admin-header">
    <h1>{% if is_hauptadmin %}ZENTRAL-DIREKTION{% else %}MANAGEMENT ({{ user.group }}){% endif %}</h1>
</div>

{% if is_hauptadmin %}
<div class="section-title"><b>‚ö†Ô∏è NUTZER-MELDUNGEN (GLOBAL)</b></div>
{% set reports_count = namespace(value=0) %}
{% for target_email, rep_list in REPORTS.items() %}
    {% set reports_count.value = reports_count.value + 1 %}
    <div class="card report-card" id="report-{{ loop.index }}">
        <b style="color: var(--orange);">MELDUNG GEGEN: {{ USERS[target_email].name if target_email in USERS else target_email }}</b>
        <div class="info-box">
            {% for r in rep_list %}
                <div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 5px;">
                    <small>{{ r.date }} - {{ r.time }}</small><br>
                    <b>Von:</b> {{ r.from }}<br>
                    <b>Grund:</b> {{ r.reason }}
                </div>
            {% endfor %}
        </div>
        <div class="actions">
            <button class="btn-action btn-unban" onclick="dismissReport('{{ target_email }}')">ERLEDIGT / L√ñSCHEN</button>
            <button class="btn-action btn-ban" onclick="toggleBan('{{ target_email }}')">BANNEN</button>
        </div>
    </div>
{% endfor %}
{% if reports_count.value == 0 %}
    <p style="text-align: center; color: gray; font-size: 0.8em; margin: 20px;">Keine neuen Meldungen.</p>
{% endif %}

<div class="section-title"><b>üè¢ GRUPPEN√úBERSICHT</b></div>
{% for g_name, g_data in GROUPS.items() %}
<div class="card">
    <b style="font-size: 1.2em;">{{ g_name }}</b><br>
    <div style="margin-top: 10px; font-family: monospace; font-size: 0.9em;">
        <b>TYP:</b> {{ g_data.type | upper }}<br>
        <b>PASSWORT:</b> <span style="color: var(--blue); font-weight: bold;">{{ g_data.password if g_data.password else 'KEINS' }}</span>
    </div>
    <div class="actions">
        <button class="btn-action btn-del" onclick="deleteGroup('{{ g_name }}')">GRUPPE UNWIDERRUFLICH L√ñSCHEN</button>
    </div>
</div>
{% endfor %}
{% endif %}

<div class="section-title"><b>üë• NUTZER VERWALTEN</b></div>
{% for m_email in members %}
    {% if m_email in USERS %}
    {% set u_data = USERS[m_email] %}
    {% set is_owner = (m_email == 'yunusemreguevercin12@gmail.com') %}

    <div class="card {% if is_owner %}owner-card{% endif %} {% if u_data.banned %}banned{% endif %}">
        <b>{{ u_data.name }}</b> 
        {% if is_owner %}<span style="color:var(--blue)">[INHABER]</span>{% endif %}
        
        <div class="info-box">
            <div>üìß ID: {% if is_owner %}GEBLOCKT{% else %}{{ m_email }}{% endif %}</div>
            <div>üîë PW: 
                {% if is_owner %}
                    ********
                {% else %}
                    <input type="text" value="{{ u_data.password }}" id="pw-{{ loop.index }}" class="pw-input">
                    <button class="btn-action btn-save" onclick="changePassword('{{ m_email }}', 'pw-{{ loop.index }}')">SPEICHERN</button>
                {% endif %}
            </div>
            <div>üè† GRUPPE: {{ u_data.group if u_data.group else 'Keine' }}</div>
        </div>

        <div class="actions">
            {% if not is_owner and m_email != session['email'] %}
                <select onchange="updateUser('{{ m_email }}', 'role', this.value)">
                    <option value="SANI" {% if u_data.role == 'SANI' %}selected{% endif %}>SANI</option>
                    <option value="ADMIN" {% if u_data.role == 'ADMIN' %}selected{% endif %}>ADMIN</option>
                    {% if is_hauptadmin %}<option value="HAUPTADMIN" {% if u_data.role == 'HAUPTADMIN' %}selected{% endif %}>HAUPTADMIN</option>{% endif %}
                </select>

                <button class="btn-action {% if u_data.banned %}btn-unban{% else %}btn-ban{% endif %}" onclick="toggleBan('{{ m_email }}')">
                    {% if u_data.banned %}ENTSPERREN{% else %}BANNEN{% endif %}
                </button>

                <a href="{{ url_for('banned', target_email=m_email) }}" class="btn-action btn-chat">üí¨ CHAT</a>

                {% if is_hauptadmin %}
                    <button class="btn-action btn-user-del" onclick="deleteUserPermanently('{{ m_email }}')">üö® USER L√ñSCHEN</button>
                {% endif %}

            {% elif is_owner %}
                <b style="color:var(--blue); font-size:0.7em;">üõ°Ô∏è SYSTEM-SCHUTZ</b>
            {% else %}
                <small>DEIN PROFIL</small>
            {% endif %}
        </div>
    </div>
    {% endif %}
{% endfor %}

{% if not is_hauptadmin %}
<nav class="nav-bar">
    <a href="/dashboard" class="nav-item">üè†<br>dashboard</a>
    <a href="/management" class="nav-item active">‚öôÔ∏è<br>ADMIN</a>
    <a href="/logout" class="nav-item" style="color: var(--red);">üö™<br>Logout</a>
</nav>
{% else %}
<div style="text-align: center; padding: 40px;">
    <a href="/logout" style="color: var(--red); font-weight: bold; text-decoration: none; border: 3px solid var(--red); padding: 15px 40px; display: inline-block; background: white;">üö™ SYSTEM-LOGOUT</a>
</div>
{% endif %}

<script>
function changePassword(email, inputId) {
    const newPw = document.getElementById(inputId).value;
    if(!newPw) return;
    fetch('/api/admin/update_user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email: email, password: newPw})
    }).then(() => alert("Passwort ge√§ndert"));
}

function toggleBan(email) {
    if(!confirm("Sperrstatus √§ndern?")) return;
    fetch('/api/admin/toggle_ban', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email: email})
    }).then(() => location.reload());
}

function dismissReport(email) {
    if(!confirm("Meldung l√∂schen?")) return;
    fetch('/api/admin/dismiss_report', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email: email}) 
    }).then(() => location.reload());
}

function deleteUserPermanently(email) {
    if(!confirm("Soll der User " + email + " wirklich unwiderruflich gel√∂scht werden?")) return;
    fetch('/api/admin/delete_user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email: email})
    }).then(res => res.json()).then(data => {
        if(data.status === 'ok') location.reload();
        else alert(data.message);
    });
}

function updateUser(email, field, val) {
    fetch('/api/admin/update_user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email: email, field: field, value: val })
    }).then(r => r.json()).then(data => {
        if(data.status !== 'ok') {
            alert("Fehler: " + data.message);
            location.reload();
        }
    });
}

function deleteGroup(gName) {
    if(!confirm("Gruppe " + gName + " l√∂schen?")) return;
    fetch('/api/admin/delete_group', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({group_name: gName})
    }).then(() => location.reload());
}
</script>
{% endblock %}