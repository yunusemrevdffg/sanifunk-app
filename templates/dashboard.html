{% extends "base.html" %}
{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
    :root { --red: #ff0000; --dark: #000000; --white: #ffffff; }
    body { background: #f4f4f4; padding-bottom: 90px; font-family: 'Arial Black', sans-serif; overflow-x: hidden; }
    .header-branding { background: var(--red); color: white; padding: 20px; text-align: center; border-bottom: 5px solid var(--dark); text-transform: uppercase; }
    .dashboard-container { padding: 15px; max-width: 800px; margin: auto; }
    .card { background: var(--white); border: 3px solid var(--dark); padding: 15px; margin-bottom: 20px; box-shadow: 6px 6px 0px var(--red); }
    .card h3 { margin-top: 0; border-bottom: 2px solid var(--dark); padding-bottom: 5px; text-transform: uppercase; }
    input, select { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid var(--dark); font-weight: bold; box-sizing: border-box; }
    .btn-alarm { width: 100%; padding: 20px; font-size: 1.3em; background: var(--red); color: white; border: 3px solid var(--dark); font-weight: bold; cursor: pointer; text-transform: uppercase; }
    #alarmOverlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--red); color: white; z-index: 99999; text-align: center; padding-top: 40px; box-sizing: border-box; }
    .btn-stop { background: white; color: var(--red); padding: 25px; width: 90%; border: 4px solid var(--dark); font-weight: bold; font-size: 1.5em; margin-top: 30px; cursor: pointer; text-transform: uppercase; }
    .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: white; display: flex; border-top: 4px solid var(--red); z-index: 1000; }
    .nav-item { flex: 1; text-align: center; text-decoration: none; color: var(--dark); font-size: 0.7em; padding-top: 15px; font-weight: bold; text-transform: uppercase; }
</style>

<div class="header-branding">{{ user.group }} <br> <small>Einsatz-Zentrale</small></div>

<div class="dashboard-container">
    <div class="card">
        <h3>üö® NEUER EINSATZ</h3>
        <label>Empf√§nger:</label>
        <select id="target">
            <option value="all">ALLE SANIT√ÑTER</option>
            {% for m in members_emails if m != session['email'] %}
                {% if m in all_users %}
                    <option value="{{ m }}">{{ all_users[m]['name'] }}</option>
                {% endif %}
            {% endfor %}
        </select>
        <input type="text" id="msg" placeholder="Grund (z.B. Kreislaufkollaps)">
        <div style="margin: 10px 0;">
            <input type="checkbox" id="gps" checked style="width: auto;"> <label for="gps">üìç Standort mitsenden</label>
        </div>
        <button class="btn-alarm" id="sendBtn" onclick="sendAlarm()">ALARM AUSL√ñSEN</button>
    </div>
</div>

<div id="alarmOverlay">
    <div class="alarm-box">
        <h1 class="blink" style="font-size: 3.5em; margin: 0;">üö® EINSATZ</h1>
        <div id="alarmData">
            <p>Meldung von:</p>
            <h2 id="alarmFrom" style="background: white; color: var(--red); padding: 5px 15px;">-</h2>
            <p>Grund:</p>
            <h2 id="alarmText" style="font-size: 2em;">-</h2>
        </div>
        <div id="mapArea"></div>
        <button class="btn-stop" onclick="stopAlarm()">‚úÖ VERSTANDEN / STOPP</button>
    </div>
</div>

</nav class="nav-bar">
    <a href="/dashboard" class="nav-item">üè†<br>dashboard</a>
    <a href="/untis" class="nav-item active">üìÖ<br>Untis</a>
    <a href="/profile" class="nav-item active">üë§<br>Profil</a>
    <a href="/alarm_log" class="nav-item active">üö®<br>Alarme</a>
    <a href="/chat" class="nav-item">üí¨<br>CHAT</a>
    {% if user.role in ['ADMIN', 'HAUPTADMIN'] %}
    <a href="/management" class="nav-item">‚öôÔ∏è<br>ADMIN</a>
    {% endif %}
    <a href="/logout" class="nav-item" style="color: var(--red);">üö™<br>Logout</a>
</nav>

<script>
    const alarmSound = new Audio("/static/audio/alarm.mp3");
    alarmSound.loop = true;
    let isAlarmActive = false;
    let currentUserEmail = "{{ session['email'] }}";

    setInterval(() => {
        fetch('/api/check_alarm')
        .then(r => r.json())
        .then(data => {
            if (data.active) {
                // PR√úFUNG: 
                // 1. Ich bin nicht der Sender 
                // 2. Der Alarm ist f√ºr "all" ODER direkt f√ºr meine Email
                const isForMe = (data.target === 'all' || data.target === currentUserEmail);
                const iAmNotSender = (data.sender_email !== currentUserEmail);

                if (isForMe && iAmNotSender) {
                    if (!isAlarmActive) {
                        isAlarmActive = true;
                        document.getElementById('alarmFrom').innerText = data.from;
                        document.getElementById('alarmText').innerText = data.msg;
                        
                        if (data.lat && data.lng) {
                            const mapUrl = `geo:${data.lat},${data.lng}?q=${data.lat},${data.lng}(Einsatzort)`;
                            document.getElementById('mapArea').innerHTML = `<a href="${mapUrl}" style="background:white; color:black; padding:15px; text-decoration:none; display:block; margin:20px auto; width:80%; border:3px solid black; font-weight:bold; text-align:center;">üìç MAPS √ñFFNEN</a>`;
                        }

                        document.getElementById('alarmOverlay').style.display = 'block';

                        if (typeof AndroidInterface !== 'undefined') {
                            AndroidInterface.triggerAlarm("üö® EINSATZ", data.msg);
                        } else {
                            alarmSound.play().catch(e => {});
                        }
                    }
                }
            } else {
                // Alarm wurde beendet
                if (isAlarmActive) {
                    stopLocalAlarm();
                }
            }
        });
    }, 3000);

    function stopLocalAlarm() {
        isAlarmActive = false;
        document.getElementById('alarmOverlay').style.display = 'none';
        alarmSound.pause();
        alarmSound.currentTime = 0;
        if (typeof AndroidInterface !== 'undefined') AndroidInterface.stopAndroidAlarm();
    }

    function stopAlarm() {
        fetch('/api/stop_alarm', { method: 'POST' }).then(() => {
            stopLocalAlarm();
        });
    }

    function sendAlarm() {
        const btn = document.getElementById('sendBtn');
        btn.innerText = "WIRD GESENDET...";
        btn.disabled = true;

        const t = document.getElementById('target').value;
        const m = document.getElementById('msg').value || "EINSATZ-ALARM";
        
        if (document.getElementById('gps').checked) {
            navigator.geolocation.getCurrentPosition(
                p => exec(t, m, p.coords.latitude, p.coords.longitude),
                () => exec(t, m, null, null)
            );
        } else { exec(t, m, null, null); }
    }

    function exec(t, m, la, lo) {
        fetch('/api/trigger_alarm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ target: t, message: m, lat: la, lng: lo })
        }).then(() => {
            document.getElementById('sendBtn').innerText = "ERFOLGREICH!";
            setTimeout(() => { location.reload(); }, 1500);
        });
    }
</script>
{% endblock %}