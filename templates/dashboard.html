{% extends "base.html" %}
{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
    :root { --red: #ff0000; --dark: #000000; --white: #ffffff; }
    body { background: #f4f4f4; padding-bottom: 90px; font-family: 'Arial Black', sans-serif; }
    .header-branding { background: var(--red); color: white; padding: 20px; text-align: center; border-bottom: 5px solid var(--dark); text-transform: uppercase; letter-spacing: 1px; }
    .dashboard-container { padding: 15px; max-width: 800px; margin: auto; }
    .card { background: var(--white); border: 3px solid var(--dark); padding: 15px; margin-bottom: 20px; box-shadow: 6px 6px 0px var(--red); }
    .card h3 { margin-top: 0; border-bottom: 2px solid var(--dark); padding-bottom: 5px; text-transform: uppercase; font-size: 1.1em; }
    input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid var(--dark); font-weight: bold; box-sizing: border-box; font-family: sans-serif; }
    .btn-alarm { width: 100%; padding: 20px; font-size: 1.3em; background: var(--red); color: white; border: 3px solid var(--dark); font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
    .member-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #ddd; }
    .btn-report { background: none; border: none; font-size: 1.2em; cursor: pointer; filter: grayscale(1); transition: 0.2s; }
    .btn-report:hover { filter: grayscale(0); transform: scale(1.2); }
    
    /* Navigation */
    .nav-bar { position: fixed; bottom: 0; width: 100%; height: 70px; background: white; display: flex; border-top: 4px solid var(--red); z-index: 1000; }
    .nav-item { flex: 1; text-align: center; text-decoration: none; color: var(--dark); font-size: 0.7em; padding-top: 15px; font-weight: bold; }
    
    /* Overlay & Modals */
    #alarmOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--red); color:white; z-index:9999; text-align:center; padding-top:50px; }
    
    .modal { display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
    .modal-content { background-color: white; margin: 15% auto; padding: 20px; border: 4px solid var(--red); width: 85%; max-width: 400px; box-shadow: 10px 10px 0px var(--dark); }
</style>

<div class="header-branding">
    {{ user.group }} <br> <small style="font-size: 0.6em;">Einsatz-Zentrale</small>
</div>

<div class="dashboard-container">
    <div class="card">
        <h3>üö® Notfall-Alarm</h3>
        <label>Zieleinheit:</label>
        <select id="target">
            <option value="all">ALLE MITGLIEDER</option>
            {% for m in members_emails if m != session['email'] %}
            <option value="{{ m }}">{{ all_users[m]['name'] }}</option>
            {% endfor %}
        </select>
        <input type="text" id="msg" placeholder="Meldung (z.B. VU Person klemmt)">
        <div style="margin: 10px 0;">
            <input type="checkbox" id="gps" checked style="width: auto;">
            <label for="gps">üìç Standort mitsenden</label>
        </div>
        <button class="btn-alarm" onclick="sendAlarm()">ALARM SENDEN</button>
    </div>

    <div class="card">
        <h3>üë• Einheit / Team</h3>
        <div class="member-list">
            {% for m in members_emails %}
            <div class="member-item">
                <span>{{ all_users[m]['name'] }} <small style="font-size: 0.7em; color: #666;">({{ all_users[m]['role'] }})</small></span>
                {% if m != session['email'] %}
                <button class="btn-report" onclick="openReportModal('{{ m }}', '{{ all_users[m]['name'] }}')">‚ö†Ô∏è</button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div id="reportModal" class="modal">
    <div class="modal-content">
        <h2 style="text-transform: uppercase; color: var(--red); margin-top: 0;">Nutzer melden</h2>
        <p>Grund f√ºr die Meldung von <b id="reportTargetName"></b>:</p>
        <input type="hidden" id="reportTargetEmail">
        <textarea id="reportReason" rows="4" placeholder="Beschreibe das Fehlverhalten..."></textarea>
        <button class="btn-alarm" onclick="submitReport()" style="padding: 10px; font-size: 1em;">Meldung absenden</button>
        <button onclick="closeReportModal()" style="width: 100%; background: none; border: none; margin-top: 10px; cursor: pointer; text-decoration: underline;">Abbrechen</button>
    </div>
</div>

<div id="alarmOverlay">
    <h1 style="font-size:3em; margin:0; animation: blink 0.5s infinite;">üö® EINSATZ</h1>
    <p id="alarmInfo" style="font-size:1.5em; margin:20px; font-weight: bold;"></p>
    <div id="mapLink" style="margin-bottom: 20px;"></div>
    <button onclick="stopAlarm()" style="background:var(--dark); color:white; padding:25px; width:90%; border:none; border-radius:5px; font-weight:bold; font-size:1.2em; border: 2px solid white;">VERSTANDEN / STOPP</button>
</div>

<nav class="nav-bar">
    <a href="/dashboard" class="nav-item">üè†<br>dashboard</a>
    <a href="/untis" class="nav-item">üìÖ<br>Untis</a>
    <a href="/profile" class="nav-item">üë§<br>Profil</a>
    <a href="/alarm_log" class="nav-item">üö®<br>Alarme</a>
    <a href="/chat" class="nav-item">üí¨<br>CHAT</a>
    {% if user.role in ['ADMIN', 'HAUPTADMIN'] %}
    <a href="/management" class="nav-item">‚öôÔ∏è<br>ADMIN</a>
    {% endif %}
    <a href="/logout" class="nav-item" style="color: var(--red);">üö™<br>Logout</a>
</nav>

<script>
    const alarmSound = new Audio("/static/audio/alarm.mp3"); 
    alarmSound.loop = true;

    // --- REPORT FUNKTIONEN ---
    function openReportModal(email, name) {
        document.getElementById('reportTargetEmail').value = email;
        document.getElementById('reportTargetName').innerText = name;
        document.getElementById('reportModal').style.display = 'block';
    }

    function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
        document.getElementById('reportReason').value = "";
    }

    function submitReport() {
        const email = document.getElementById('reportTargetEmail').value;
        const reason = document.getElementById('reportReason').value;

        if(!reason) return alert("Bitte gib einen Grund an!");

        fetch('/api/report_user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({target_email: email, reason: reason})
        }).then(r => r.json()).then(data => {
            if(data.status === 'ok') {
                alert("Meldung wurde an die Administration gesendet.");
                closeReportModal();
            }
        });
    }

    // --- ALARM FUNKTIONEN ---
    function sendAlarm() {
        const t = document.getElementById('target').value, m = document.getElementById('msg').value;
        const btn = document.querySelector('.btn-alarm');
        btn.innerText = "SENDE...";
        btn.style.background = "orange";

        if(document.getElementById('gps').checked) {
            navigator.geolocation.getCurrentPosition(p => exec(t,m,p.coords.latitude,p.coords.longitude), () => exec(t,m,null,null));
        } else { exec(t,m,null,null); }
    }

    function exec(t, m, la, lo) {
        fetch('/api/trigger_alarm', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({target: t, message: m, lat: la, lng: lo})
        }).then(() => {
            const btn = document.querySelector('.btn-alarm');
            btn.innerText = "ERFOLGREICH ‚úÖ";
            btn.style.background = "green";
            setTimeout(() => {
                btn.innerText = "ALARM SENDEN";
                btn.style.background = "";
                document.getElementById('msg').value = "";
            }, 2000);
        });
    }

    // Alarm-Check (API-Endpoint anpassen falls n√∂tig)
    setInterval(() => {
        fetch('/api/check_alarm').then(r=>r.json()).then(d => {
            if(d.active) {
                document.getElementById('alarmOverlay').style.display='block';
                document.getElementById('alarmInfo').innerText = d.from + ": " + d.msg;
                if(d.lat) {
                    document.getElementById('mapLink').innerHTML = `<a href="https://www.google.com/maps?q=${d.lat},${d.lng}" target="_blank" style="color:white; font-weight:bold; text-decoration: underline;">üìç EINSATZORT AUF KARTE</a>`;
                }
                alarmSound.play().catch(() => {});
            }
        }).catch(e => console.log("Check-Fehler"));
    }, 4000);

    function stopAlarm() { 
        fetch('/api/stop_alarm',{method:'POST'}).then(() => { 
            alarmSound.pause(); 
            document.getElementById('alarmOverlay').style.display='none'; 
        }); 
    }
</script>
{% endblock %}