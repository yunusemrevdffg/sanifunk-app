{% extends "base.html" %}
{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
    :root { --red: #ff0000; --dark: #000000; }
    body { background: #f4f4f4; font-family: 'Arial Black', sans-serif; margin: 0; padding-bottom: 80px; }

    /* Branding */
    .header-branding { background: var(--red); color: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--dark); text-transform: uppercase; }

    /* Container */
    .dashboard-container { padding: 15px; max-width: 600px; margin: auto; }
    .card { background: white; border: 3px solid var(--dark); padding: 15px; margin-bottom: 20px; box-shadow: 5px 5px 0px var(--red); }

    /* Das Alarm-Men√º (Overlay) */
    #alarmOverlay { 
        display: none; 
        position: fixed; 
        top: 0; left: 0; 
        width: 100%; height: 100%; 
        background: var(--red); 
        color: white; 
        z-index: 999999; /* Extrem hoch damit es alles √ºberdeckt */
        text-align: center;
        padding-top: 50px;
    }

    .blink-text { animation: blink 0.5s infinite; font-size: 3em; font-weight: bold; margin: 0; }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }

    .btn-confirm { 
        background: white; color: var(--red); 
        padding: 25px; width: 85%; 
        border: 5px solid var(--dark); 
        font-size: 1.5em; font-weight: bold; 
        margin-top: 40px; text-transform: uppercase;
        cursor: pointer;
    }

    /* Buttons & Inputs */
    .btn-send { width: 100%; padding: 15px; background: var(--red); color: white; border: 3px solid var(--dark); font-weight: bold; cursor: pointer; }
    input, select { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid var(--dark); box-sizing: border-box; }

    /* Nav */
    .nav-bar { position: fixed; bottom: 0; width: 100%; height: 70px; background: white; display: flex; border-top: 4px solid var(--red); }
    .nav-item { flex: 1; text-align: center; text-decoration: none; color: black; font-size: 0.8em; padding-top: 15px; font-weight: bold; }
</style>

<div class="header-branding">
    {{ user.group }} - EINSATZLEITUNG
</div>

<div class="dashboard-container">
    <div class="card">
        <h3>üö® ALARM SENDEN</h3>
        <select id="target">
            <option value="all">ALLE EINHEITEN</option>
            {% for m in members_emails if m != session['email'] %}
                <option value="{{ m }}">{{ all_users[m]['name'] }}</option>
            {% endfor %}
        </select>
        <input type="text" id="msg" placeholder="Einsatzstichwort...">
        <button class="btn-send" onclick="sendAlarm()">ALARM JETZT AUSL√ñSEN</button>
    </div>
</div>

<div id="alarmOverlay">
    <p class="blink-text">üö® EINSATZ üö®</p>
    <div style="padding: 20px;">
        <h2 style="font-size: 1.2em; text-decoration: underline;">VON:</h2>
        <h1 id="alarmFrom" style="font-size: 2em; margin-bottom: 20px;">-</h1>
        
        <h2 style="font-size: 1.2em; text-decoration: underline;">INFO:</h2>
        <h1 id="alarmMsg" style="font-size: 2.2em;">-</h1>

        <div id="mapContainer"></div>

        <button class="btn-confirm" onclick="stopAlarm()">Gelesen / Stopp</button>
    </div>
</div>

<nav class="nav-bar">
    <a href="/dashboard" class="nav-item">üè†<br>dashboard</a>
    <a href="/untis" class="nav-item active">üìÖ<br>Untis</a>
    <a href="/profile" class="nav-item active">üë§<br>Profil</a>
    <a href="/alarm_log" class="nav-item active">üö®<br>Alarme</a>
    <a href="/chat" class="nav-item">üí¨<br>CHAT</a>
    {% if user.role in ['ADMIN', 'HAUPTADMIN'] %}
    <a href="/management" class="nav-item">‚öôÔ∏è<br>ADMIN</a>
    {% endif %}
    <a href="/logout" class="nav-item" style="color: var(--red);">üö™<br>Logout</a>
</nav>

<script>
    const alarmSound = new Audio("/static/audio/alarm.mp3");
    alarmSound.loop = true;

    // WICHTIG: Browser-Audio freischalten
    // Sobald der User IRGENDWO hinklickt, darf die App T√∂ne abspielen
    document.addEventListener('click', () => {
        alarmSound.play().then(() => {
            alarmSound.pause();
        }).catch(() => {});
    }, { once: true });

    // Polling: Alle 3 Sekunden pr√ºfen
    function checkAlarm() {
        fetch('/api/check_alarm')
        .then(res => res.json())
        .then(data => {
            if(data.active) {
                const overlay = document.getElementById('alarmOverlay');
                if(overlay.style.display !== 'block') {
                    // Infos ins Men√º schreiben
                    document.getElementById('alarmFrom').innerText = data.from;
                    document.getElementById('alarmMsg').innerText = data.msg;
                    
                    if(data.lat) {
                        document.getElementById('mapContainer').innerHTML = 
                            `<a href="https://www.google.com/maps?q=${data.lat},${data.lng}" target="_blank" style="color:white; font-size:1.2em;">üìç EINSATZORT √ñFFNEN</a>`;
                    }

                    // Men√º anzeigen & Sound starten
                    overlay.style.display = 'block';
                    alarmSound.play().catch(e => alert("ALARM! Bitte Bildschirm ber√ºhren f√ºr Sound!"));
                }
            }
        });
    }

    setInterval(checkAlarm, 3000);

    function stopAlarm() {
        fetch('/api/stop_alarm', { method: 'POST' }).then(() => {
            alarmSound.pause();
            alarmSound.currentTime = 0;
            document.getElementById('alarmOverlay').style.display = 'none';
        });
    }

    function sendAlarm() {
        const t = document.getElementById('target').value;
        const m = document.getElementById('msg').value || "Einsatzalarm!";
        
        // Versuchen GPS zu kriegen, sonst ohne senden
        navigator.geolocation.getCurrentPosition(
            (pos) => execSend(t, m, pos.coords.latitude, pos.coords.longitude),
            () => execSend(t, m, null, null),
            { timeout: 5000 }
        );
    }

    function execSend(t, m, lat, lng) {
        fetch('/api/trigger_alarm', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({target: t, message: m, lat: lat, lng: lng})
        }).then(() => {
            alert("Alarm wurde gesendet!");
            document.getElementById('msg').value = "";
        });
    }
</script>
{% endblock %}